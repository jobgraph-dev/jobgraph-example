---
stages:
- decision
- generated-pipeline

variables:
    TARGET_JOBS_METHOD: default     # Can be overriden by schedules

decision:
    artifacts:
        expire_in: 1 year
        paths:
        - artifacts/*
    image: registry.gitlab.com/johanlorenzo/jobgraph/decision:a1402e64dec978d43c6416fecf9e874451d0d5d0b1f70f98ab6249bf2c0da688@sha256:4dc2b97462958f01c94820e327d683d00425299b416d117ad840645466c95481
    retry:
        max: 2
        when:
        - unknown_failure
        - stale_schedule
        - runner_system_failure
        - stuck_or_timeout_failure
    script:
    - >-
        if [ -n "$CI_MERGE_REQUEST_SOURCE_PROJECT_URL" ] && [ "$CI_MERGE_REQUEST_SOURCE_PROJECT_URL" != '' ]; then
            export BASE_REPOSITORY="$CI_MERGE_REQUEST_SOURCE_PROJECT_URL"
        else
            export BASE_REPOSITORY="$CI_PROJECT_URL"
        fi

    # We fetch the main branch of the repository so that jobgraph can determine
    # the actual base revision in case $CI_COMMIT_BEFORE_SHA equals
    # "0000000000000000000000000000000000000000".
    #
    # See https://docs.gitlab.com/ee/ci/variables/predefined_variables.html
    - export DEFAULT_BRANCH_SHORT_NAME="$(git ls-remote --symref origin HEAD | awk '/^ref:/ {sub(/refs\/heads\//, "", $2); print $2}')"
    - git fetch "$GIT_REMOTE_NAME" "$DEFAULT_BRANCH_SHORT_NAME"

    - >-
        jobgraph decision
        --base-repository="$BASE_REPOSITORY"
        --base-rev="$CI_COMMIT_BEFORE_SHA"
        --head-ref="$CI_COMMIT_BRANCH"
        --head-repository="$CI_PROJECT_URL"
        --head-rev="$CI_COMMIT_SHA"
        --head-tag="$CI_COMMIT_TAG"
        --is-head-ref-protected="$CI_COMMIT_REF_PROTECTED"
        --message="$CI_COMMIT_MESSAGE"
        --owner="$CI_COMMIT_AUTHOR"
        --pipeline-source="$CI_PIPELINE_SOURCE"
        --target-jobs-method="$TARGET_JOBS_METHOD"
    stage: decision
    variables:
        # We need the full history to ensure jobgraph makes the right decisions
        GIT_DEPTH: 0
        GIT_STRATEGY: clone
        GIT_REMOTE_NAME: origin


generated-pipeline:
    stage: generated-pipeline
    trigger:
        include:
        - artifact: artifacts/generated-gitlab-ci.yml
          job: decision
        strategy: depend
